<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parihara Payment Status ‚Äì Kharif 2025‚Äì26 | DC Office Bidar</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: "Noto Sans", "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f4fb;   /* light background */
            color: #222;
        }

        /* MAIN HEADER ‚Äì like original site */
        header.main-header {
            background: #fff4fb;
            border-bottom: 3px solid #9c004d;
            padding: 8px 24px 6px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .header-block {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .header-block.center {
            flex-direction: column;
            text-align: center;
            gap: 3px;
        }
        .profile-pic {
            width: 54px;
            height: 54px;
            border-radius: 50%;
            border: 3px solid #c00060;
            object-fit: cover;
        }
        .official-name {
            font-weight: 600;
            font-size: 0.9rem;
            color: #3b1842;
        }
        .official-desg {
            font-size: 0.78rem;
            opacity: 0.85;
            color: #7b516d;
        }

        .dept-main-title {
            font-size: 1.1rem;
            letter-spacing: 0.12em;
            font-weight: 700;
            color: #004a9f;
        }
        .dept-subtitle {
            font-size: 0.86rem;
            text-transform: uppercase;
            color: #9c004d;
            font-weight: 600;
        }
        .dept-govt-line {
            font-size: 0.78rem;
            text-transform: uppercase;
            color: #555;
            letter-spacing: 0.08em;
        }
        .scheme-line {
            margin-top: 2px;
            font-size: 0.85rem;
            font-weight: 600;
            color: #9c004d;
        }

        .emblem-wrapper {
            margin-top: 4px;
            margin-bottom: 4px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: #ffffff;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 0 4px rgba(0,0,0,0.15);
        }
        .emblem-wrapper img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
        }

        @media (max-width: 768px) {
            header.main-header {
                flex-direction: column;
                gap: 8px;
                align-items: stretch;
                text-align: center;
            }
            .header-block {
                justify-content: center;
            }
            .header-block.center {
                order: -1;
            }
        }

        /* Marquee */
        .news-ticker {
            background-color: #ffeef7;
            color: #7a0040;
            padding: 6px 10px;
            font-size: 0.9rem;
            border-bottom: 1px solid #f3c7dd;
        }

        .container {
            max-width: 1200px;
            margin: 18px auto 30px auto;
            padding: 0 16px 0 16px;
        }

        .card {
            background: #ffffff;
            border-radius: 18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            padding: 20px 20px 18px 20px;
            margin-bottom: 18px;
            border: 2px solid #f0c1dc;              /* pink border like tiles */
            border-top: 4px solid #c00060;
        }
        .card-title {
            margin-top: 0;
            color: #7a0040;
            border-bottom: 1px solid #f3e1f0;
            padding-bottom: 10px;
            margin-bottom: 18px;
            font-size: 1.05rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(210px, 1fr));
            gap: 15px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
        }
        .form-group label {
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 4px;
            color: #5c3550;
        }
        .form-group input,
        .form-group select {
            padding: 7px 8px;
            border: 1px solid #d1b3c6;
            border-radius: 6px;
            font-size: 0.9rem;
            background-color: #fff;
            transition: border 0.2s, box-shadow 0.2s;
        }
        .form-group input:focus,
        .form-group select:focus {
            border-color: #9c004d;
            outline: none;
            box-shadow: 0 0 3px rgba(156, 0, 77, 0.4);
        }

        .btn-container {
            margin-top: 4px;
            margin-bottom: 12px;
            text-align: right;
        }
        button {
            background-color: #9c004d;
            color: white;
            border: none;
            padding: 9px 22px;
            font-size: 0.88rem;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            letter-spacing: 0.02em;
            transition: background 0.2s, transform 0.05s, box-shadow 0.1s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.18);
        }
        button:hover {
            background-color: #b6005a;
        }
        button:active {
            transform: scale(0.97);
            box-shadow: 0 1px 2px rgba(0,0,0,0.25);
        }
        button#resetBtn {
            background-color: #757575;
            margin-right: 8px;
        }
        button#resetBtn:hover {
            background-color: #616161;
        }

        /* View toggle (Success / Failure) */
        .view-toggle {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            border-bottom: 1px solid #f3e1f0;
            padding-bottom: 8px;
        }
        .view-btn {
            background-color: #ffe4f3;
            border: 1px solid #f0c1dc;
            color: #7a0040;
            padding: 6px 16px;
            font-size: 0.8rem;
            border-radius: 20px;
            cursor: pointer;
        }
        .view-btn.active {
            background-color: #9c004d;
            color: #fff;
            border-color: #9c004d;
        }

        .table-responsive {
            overflow-x: auto;
            border: 1px solid #f0c1dc;
            border-radius: 10px;
            max-height: 600px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        th, td {
            padding: 9px 10px;
            text-align: left;
            border-bottom: 1px solid #f5e3f0;
        }
        th {
            background-color: #fff7fd;
            color: #5c3550;
            position: sticky;
            top: 0;
            font-weight: 700;
            border-bottom: 2px solid #f0c1dc;
            z-index: 1;
        }
        tbody tr:nth-child(even) { background-color: #fdf7ff; }
        tbody tr:hover { background-color: #f5e3f5; }
        td.calculated {
            color: #1b5e20;
            font-weight: 700;
            background-color: #f1f8e9;
        }

        .loading {
            text-align: center;
            padding: 14px;
            color: #666;
            font-style: italic;
            font-size: 0.9rem;
        }

        footer {
            text-align: center;
            padding: 12px;
            background-color: #7a0040;
            color: white;
            font-size: 0.8rem;
            margin-top: 30px;
            border-top: 4px solid #ffb300;
        }

        @media (max-width: 600px) {
            .card {
                padding: 16px;
            }
        }
    </style>
</head>
<body>

<header class="main-header">
    <div class="header-block left">
        <img src="dc_profile.png" alt="DC" class="profile-pic">
        <div>
            <div class="official-name">Smt. Shilpa Sharma, IAS</div>
            <div class="official-desg">Deputy Commissioner & District Magistrate</div>
        </div>
    </div>

    <div class="header-block center">
        <!-- EMBLEM ABOVE TEXT -->
        <div class="emblem-wrapper">
            <img src="gok.png" alt="Government of Karnataka Emblem">
        </div>
        <div class="dept-main-title">DEPUTY COMMISSIONER OFFICE, BIDAR</div>
        <div class="dept-subtitle">REVENUE DEPARTMENT</div>
        <div class="dept-govt-line">GOVERNMENT OF KARNATAKA</div>
        <div class="scheme-line">Parihara Payment Status ‚Äì Kharif 2025‚Äì26</div>
    </div>

    <div class="header-block right">
        <div>
            <div class="official-name" style="text-align:right;">Sri Shivanand B Karale, KAS</div>
            <div class="official-desg" style="text-align:right;">Additional Deputy Commissioner, Bidar</div>
        </div>
        <img src="adc_profile.png" alt="ADC" class="profile-pic">
    </div>
</header>

<div class="news-ticker">
    <marquee behavior="scroll" direction="left" style="color:#b0004d; font-weight:600;">
        Parihara payment disbursement is processed. Farmers are requested to verify Farmer ID, Taluk, Hobli, Village, Survey Number, Surnoc and Hissa Number carefully before relying on the information displayed. ‚Äì For Payment Status & Failure Cases, search below.
    </marquee>
</div>

<div class="container">

    <!-- 1. SEARCH CARD -->
    <div class="card">
        <h3 class="card-title">üîç Search Beneficiary Details</h3>

        <!-- BUTTONS ABOVE SUCCESS / FAILURE -->
        <div class="btn-container">
            <button id="resetBtn">Reset</button>
            <button id="filterBtn">Search Record</button>
        </div>

        <!-- SUCCESS / FAILURE TOGGLE BELOW BUTTONS -->
        <div class="view-toggle">
            <button class="view-btn active" data-view="success">Successful Payments</button>
            <button class="view-btn" data-view="failure">Failure Cases</button>
        </div>
        
        <!-- GRID BELOW ONLY -->
        <div class="filter-grid">
            <div class="form-group">
                <label for="filter-FarmerID">Farmer ID</label>
                <input id="filter-FarmerID" type="text" placeholder="Ex: FID0505...">
            </div>
            <div class="form-group">
                <label for="filter-Taluk">Taluk</label>
                <select id="filter-Taluk">
                    <option value="">All Taluks</option>
                </select>
            </div>
            <div class="form-group">
                <label for="filter-Hobli">Hobli</label>
                <select id="filter-Hobli">
                    <option value="">All Hoblis</option>
                </select>
            </div>
            <div class="form-group">
                <label for="filter-Village">Village</label>
                <select id="filter-Village">
                    <option value="">All Villages</option>
                </select>
            </div>
            <div class="form-group">
                <label for="filter-SurveyNo">Survey No</label>
                <input id="filter-SurveyNo" type="text" placeholder="Ex: 341">
            </div>
            <div class="form-group">
                <label for="filter-Surnoc">Surnoc</label>
                <input id="filter-Surnoc" type="text" placeholder="Ex: *">
            </div>
            <div class="form-group">
                <label for="filter-HissaNo">Hissa No</label>
                <input id="filter-HissaNo" type="text" placeholder="Ex: 1">
            </div>
        </div>
    </div>

    <!-- 2. PAYMENT RECORDS (BOTTOM ‚Äì SHOW RESULTS HERE) -->
    <div class="card">
        <h3 class="card-title">üè¶ Parihara Payment Records</h3>

        <div class="table-responsive">
            <table id="data-table">
                <thead>
                    <tr id="table-header-row">
                        <!-- filled dynamically -->
                    </tr>
                </thead>
                <tbody id="table-body"></tbody>
            </table>
            <div id="loading-msg" class="loading">Connecting to payment database...</div>
            <div id="no-data-msg" class="loading" style="display:none;">Please enter search details and click "Search Record".</div>
        </div>
    </div>

</div>

<footer>
    &copy; 2025 Department of Revenue & Land Records, Deputy Commissioner Office Bidar, Government of Karnataka. All Rights Reserved.
</footer>

<script>
    // ===== CONFIGURATION =====
    const sheetId    = '1H_UVcsLACA3wuQmB-9xzFhUciuwS3AXRQwYtX98rynU'; // Same spreadsheet
    const apiKey     = 'AIzaSyBAcoUk7WdsMo3GA8NXfEc7e_v-ugsYddg';

    const sheetNameSuccess = 'PARIHARA_PAYMENT';
    const sheetNameFailure = 'PARIHARA_FAILURE';

    const rangeSuccess = encodeURIComponent(sheetNameSuccess + '!A1:Z');
    const rangeFailure = encodeURIComponent(sheetNameFailure + '!A1:Z');

    const apiUrlSuccess = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${rangeSuccess}?key=${apiKey}`;
    const apiUrlFailure = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${rangeFailure}?key=${apiKey}`;

    let allSuccess = [];   // Successful payments
    let allFailure = [];   // Failure cases
    let currentView = 'success'; // 'success' or 'failure'

    const tableBody       = document.getElementById('table-body');
    const loadingMsg      = document.getElementById('loading-msg');
    const noDataMsg       = document.getElementById('no-data-msg');
    const tableHeaderRow  = document.getElementById('table-header-row');

    const talukSelect     = document.getElementById('filter-Taluk');
    const hobliSelect     = document.getElementById('filter-Hobli');
    const villageSelect   = document.getElementById('filter-Village');

    const filterFarmerID  = document.getElementById('filter-FarmerID');
    const filterSurveyNo  = document.getElementById('filter-SurveyNo');
    const filterSurnoc    = document.getElementById('filter-Surnoc');
    const filterHissaNo   = document.getElementById('filter-HissaNo');

    const filterBtn       = document.getElementById('filterBtn');
    const resetBtn        = document.getElementById('resetBtn');
    const viewButtons     = document.querySelectorAll('.view-btn');

    const columnOrderSuccess = [
        'FarmerID',
        'Taluk',
        'Hobli',
        'Village',
        'SurveyNo',
        'Surnoc',
        'HissaNo',
        'OwnerName',
        'CalculatedAmount'
    ];

    const columnOrderFailure = [
        'FarmerID',
        'Taluk',
        'Hobli',
        'Village',
        'SurveyNo',
        'Surnoc',
        'HissaNo',
        'OwnerName',      // mapped from "Name as in FRUITS"
        'PaymentStatus'
    ];

    function populateSelect(selectEl, values, placeholder) {
        selectEl.innerHTML = '';
        const defaultOpt = document.createElement('option');
        defaultOpt.value = '';
        defaultOpt.textContent = placeholder;
        selectEl.appendChild(defaultOpt);

        values.sort().forEach(val => {
            if (!val) return;
            const opt = document.createElement('option');
            opt.value = val;
            opt.textContent = val;
            selectEl.appendChild(opt);
        });
    }

    function getUnique(values) {
        return [...new Set(values.map(v => (v || '').trim()).filter(Boolean))];
    }

    function combinedData() {
        return [...allSuccess, ...allFailure];
    }

    async function fetchData() {
        try {
            const [resSuccess, resFailure] = await Promise.all([
                fetch(apiUrlSuccess),
                fetch(apiUrlFailure)
            ]);

            if (!resSuccess.ok) throw new Error('Success sheet HTTP Error: ' + resSuccess.status);
            if (!resFailure.ok) throw new Error('Failure sheet HTTP Error: ' + resFailure.status);

            const jsonSuccess = await resSuccess.json();
            const jsonFailure = await resFailure.json();

            // ===== SUCCESS DATA =====
            const rowsS = jsonSuccess.values || [];
            if (rowsS.length > 1) {
                const headersS = rowsS[0].map(h => (h || '').trim());
                allSuccess = rowsS.slice(1).map(row => {
                    const obj = {};
                    headersS.forEach((h, i) => {
                        if (!h) return;
                        obj[h] = row[i] || '';
                    });
                    obj.FarmerID         = obj.FarmerID || '';
                    obj.OwnerName        = obj.OwnerName || obj['Name as in FRUITS'] || '';
                    obj.CalculatedAmount = obj.CalculatedAmount || '';
                    return obj;
                });
            }

            // ===== FAILURE DATA =====
            const rowsF = jsonFailure.values || [];
            if (rowsF.length > 1) {
                const headersF = rowsF[0].map(h => (h || '').trim());
                allFailure = rowsF.slice(1).map(row => {
                    const obj = {};
                    headersF.forEach((h, i) => {
                        if (!h) return;
                        if (h === 'Name as in FRUITS') {
                            obj.OwnerName = row[i] || '';
                        } else {
                            obj[h] = row[i] || '';
                        }
                    });
                    obj.FarmerID      = obj.FarmerID || '';
                    obj.PaymentStatus = obj.PaymentStatus || '';
                    return obj;
                });
            }

            // Dropdowns: union of Taluk from both datasets
            const uniqueTaluk = getUnique([
                ...allSuccess.map(r => r.Taluk),
                ...allFailure.map(r => r.Taluk)
            ]);
            populateSelect(talukSelect, uniqueTaluk, 'All Taluks');

            // Initially Hobli & Village as "All ..."
            populateSelect(hobliSelect,   [], 'All Hoblis');
            populateSelect(villageSelect, [], 'All Villages');

            loadingMsg.style.display = 'none';
            noDataMsg.style.display = 'block';
            noDataMsg.textContent = 'Data loaded. Select view and enter search details, then click "Search Record".';

            // Render initial header for success view
            renderTableHeader('success');

        } catch (err) {
            loadingMsg.textContent = 'Error loading data. Please check API key / Sheet sharing.';
            loadingMsg.style.color = 'red';
        }
    }

    function renderTableHeader(view) {
        tableHeaderRow.innerHTML = '';
        const headers = (view === 'success')
            ? ['Farmer ID','Taluk','Hobli','Village','Survey No','Surnoc','Hissa No','Owner Name','Calculated Amount (‚Çπ)']
            : ['Farmer ID','Taluk','Hobli','Village','Survey No','Surnoc','Hissa No','Owner Name','Payment Status'];

        headers.forEach(text => {
            const th = document.createElement('th');
            th.textContent = text;
            tableHeaderRow.appendChild(th);
        });
    }

    function updateHobliOptions() {
        const selectedTaluk = talukSelect.value.trim();
        const data = combinedData();
        let hoblis;

        if (!selectedTaluk) {
            hoblis = getUnique(data.map(r => r.Hobli));
        } else {
            hoblis = getUnique(
                data
                    .filter(r => (r.Taluk || '').trim() === selectedTaluk)
                    .map(r => r.Hobli)
            );
        }

        populateSelect(hobliSelect, hoblis, 'All Hoblis');
        updateVillageOptions();
    }

    function updateVillageOptions() {
        const selectedTaluk = talukSelect.value.trim();
        const selectedHobli = hobliSelect.value.trim();
        const data = combinedData();
        let villages;

        if (!selectedTaluk && !selectedHobli) {
            villages = getUnique(data.map(r => r.Village));
        } else if (selectedTaluk && !selectedHobli) {
            villages = getUnique(
                data
                    .filter(r => (r.Taluk || '').trim() === selectedTaluk)
                    .map(r => r.Village)
            );
        } else if (selectedTaluk && selectedHobli) {
            villages = getUnique(
                data
                    .filter(r =>
                        (r.Taluk || '').trim() === selectedTaluk &&
                        (r.Hobli || '').trim() === selectedHobli
                    )
                    .map(r => r.Village)
            );
        } else {
            villages = getUnique(
                data
                    .filter(r => (r.Hobli || '').trim() === selectedHobli)
                    .map(r => r.Village)
            );
        }

        populateSelect(villageSelect, villages, 'All Villages');
    }

    function displayRows(records, view) {
        tableBody.innerHTML = '';

        const isSuccess = (view === 'success');
        const colOrder = isSuccess ? columnOrderSuccess : columnOrderFailure;
        const lastField = isSuccess ? 'CalculatedAmount' : 'PaymentStatus';

        const validRecords = records.filter(r => {
            const val = (r[lastField] || '').toString().trim();
            return val !== '';
        });

        if (validRecords.length === 0) {
            noDataMsg.style.display = 'block';
            noDataMsg.textContent = 'No records found for given criteria.';
            return;
        } else {
            noDataMsg.style.display = 'none';
        }

        const MAX_ROWS = 200;
        const slice = validRecords.slice(0, MAX_ROWS);
        if (validRecords.length > MAX_ROWS) {
            noDataMsg.style.display = 'block';
            noDataMsg.textContent = `Showing first ${MAX_ROWS} of ${validRecords.length} records. Refine filters for more precise results.`;
        }

        slice.forEach(rec => {
            const tr = document.createElement('tr');

            colOrder.forEach(field => {
                const td = document.createElement('td');
                td.textContent = rec[field] || '';
                if (field === 'CalculatedAmount' || field === 'PaymentStatus') {
                    td.classList.add('calculated');
                }
                tr.appendChild(td);
            });

            tableBody.appendChild(tr);
        });
    }

    function applyFilters() {
        const data = currentView === 'success' ? allSuccess : allFailure;

        const farmerFilter  = filterFarmerID.value.trim().toLowerCase();
        const talukFilter   = talukSelect.value.trim();
        const hobliFilter   = hobliSelect.value.trim();
        const villageFilter = villageSelect.value.trim();
        const surveyFilter  = filterSurveyNo.value.trim().toLowerCase();
        const surnocFilter  = filterSurnoc.value.trim().toLowerCase();
        const hissaFilter   = filterHissaNo.value.trim().toLowerCase();

        const filtered = data.filter(r => {
            const farmerID  = (r.FarmerID || '').toLowerCase();
            const taluk     = (r.Taluk || '').trim();
            const hobli     = (r.Hobli || '').trim();
            const village   = (r.Village || '').trim();
            const surveyNo  = (r.SurveyNo || '').toLowerCase();
            const surnoc    = (r.Surnoc || '').toLowerCase();
            const hissaNo   = (r.HissaNo || '').toLowerCase();

            if (farmerFilter && !farmerID.includes(farmerFilter)) return false;
            if (talukFilter && taluk !== talukFilter) return false;
            if (hobliFilter && hobli !== hobliFilter) return false;
            if (villageFilter && village !== villageFilter) return false;
            if (surveyFilter && !surveyNo.includes(surveyFilter)) return false;
            if (surnocFilter && !surnoc.includes(surnocFilter)) return false;
            if (hissaFilter && !hissaNo.includes(hissaFilter)) return false;

            return true;
        });

        displayRows(filtered, currentView);
    }

    function resetFilters() {
        filterFarmerID.value  = '';
        filterSurveyNo.value  = '';
        filterSurnoc.value    = '';
        filterHissaNo.value   = '';
        talukSelect.value     = '';
        populateSelect(hobliSelect,   [], 'All Hoblis');
        populateSelect(villageSelect, [], 'All Villages');

        tableBody.innerHTML = '';
        noDataMsg.style.display = 'block';
        noDataMsg.textContent = 'Please enter search details and click "Search Record".';
    }

    // ===== EVENT LISTENERS =====
    talukSelect.addEventListener('change', () => {
        updateHobliOptions();
    });

    hobliSelect.addEventListener('change', () => {
        updateVillageOptions();
    });

    filterBtn.addEventListener('click', () => {
        applyFilters();
    });

    resetBtn.addEventListener('click', () => {
        resetFilters();
    });

    viewButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            const view = btn.getAttribute('data-view');
            if (view === currentView) return;

            currentView = view;
            viewButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            renderTableHeader(currentView);

            // If filters already entered, re-apply on new view
            applyFilters();
        });
    });

    // Initial load
    fetchData();
</script>

</body>
</html>
